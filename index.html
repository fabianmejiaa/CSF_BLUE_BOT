<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistente Virtual - Voz Completa</title>

<style>
    /* -------------------------------
       ESTILO GENERAL ‚Äì AZUL MODERNO
    ---------------------------------*/
    body {
        margin: 0;
        font-family: "Inter", Arial, sans-serif;
        background: linear-gradient(135deg, #d9eaff, #8bbcff);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }

    /* CONTENEDOR PRINCIPAL */
    .app-container {
        width: 480px;
        max-width: 100%;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* CABECERA CON ESTADO SEPARADO */
    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 5px;
        margin-bottom: 5px;
    }

    /* Indicador de conexi√≥n - SEPARADO DEL CHAT */
    #connectionStatus {
        background: rgba(255, 255, 255, 0.25);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #connectionStatus.online {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border-color: rgba(40, 167, 69, 0.3);
    }

    #connectionStatus.online .status-icon {
        color: #28a745;
    }

    #connectionStatus.offline {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border-color: rgba(220, 53, 69, 0.3);
    }

    #connectionStatus.offline .status-icon {
        color: #dc3545;
    }

    .status-icon {
        font-size: 16px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    /* Bot√≥n refresh en cabecera */
    .header-buttons {
        display: flex;
        gap: 10px;
    }

    .header-btn {
        background: rgba(255,255,255,0.4);
        border: none;
        color: #03426f;
        padding: 8px 15px;
        cursor: pointer;
        border-radius: 12px;
        font-size: 14px;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.4);
    }

    .header-btn:hover {
        background: rgba(255,255,255,0.8);
        transform: translateY(-1px);
    }

    /* CONTENEDOR DEL CHAT - SIN ESTADO DENTRO */
    #chatContainer {
        height: 78vh;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 20px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(18px);
        border: 1px solid rgba(255,255,255,0.5);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        position: relative;
        overflow: hidden;
    }

    /* √ÅREA DEL CHAT */
    #chat {
        flex: 1;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 10px;
    }

    /* -------------------------------
        BURBUJAS DE MENSAJE
    ---------------------------------*/
    .msg {
        margin-bottom: 14px;
        padding: 12px 16px;
        border-radius: 14px;
        max-width: 80%;
        line-height: 1.5;
        word-wrap: break-word;
        font-size: 15px;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* MENSAJE DEL USUARIO */
    .user {
        background: #0d6efd;
        color: white;
        margin-left: auto;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
    }

    /* MENSAJE DEL BOT */
    .bot {
        background: rgba(255,255,255,0.6);
        color: #02375d;
        border: 1px solid rgba(255,255,255,0.7);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        position: relative;
    }

    /* ONDAS DE AUDIO - VISIBLES */
    .audio-waves {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 3px;
        height: 30px;
        margin-top: 10px;
        padding: 5px 0;
    }

    .wave-bar {
        width: 4px;
        background: linear-gradient(to top, #0d6efd, #25d1fd);
        border-radius: 3px;
        animation: wave 1.2s ease-in-out infinite;
    }

    .wave-bar:nth-child(1) { animation-delay: 0.0s; height: 8px; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 12px; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 16px; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 20px; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 16px; }
    .wave-bar:nth-child(6) { animation-delay: 0.5s; height: 12px; }
    .wave-bar:nth-child(7) { animation-delay: 0.6s; height: 8px; }

    @keyframes wave {
        0%, 100% { transform: scaleY(0.5); }
        50% { transform: scaleY(1.5); }
    }

    /* BOT√ìN DE MICR√ìFONO */
    #micBtn {
        background: #28a745 !important;
        color: white !important;
        position: relative;
    }

    #micBtn.recording {
        background: #dc3545 !important;
        animation: pulseRed 1.5s infinite;
    }

    @keyframes pulseRed {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }

    /* -------------------------------
        INPUTS Y BOTONES
    ---------------------------------*/
    #inputBox {
        display: flex;
        margin-top: auto;
        gap: 8px;
        align-items: center;
        background: rgba(255,255,255,0.3);
        padding: 12px;
        border-radius: 16px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.4);
    }

    #messageInput {
        flex: 1;
        padding: 12px 15px;
        border-radius: 12px;
        border: none;
        outline: none;
        font-size: 14px;
        background: rgba(255,255,255,0.7);
        color: #02375d;
        transition: all 0.3s;
        min-height: 44px;
    }

    #messageInput:focus {
        background: rgba(255,255,255,0.9);
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3);
    }

    #messageInput:disabled {
        background: rgba(255,255,255,0.4);
        cursor: not-allowed;
    }

    /* BOT√ìN ENVIAR - CON TEXTO "ENVIAR" */
    #sendBtn {
        padding: 12px 20px;
        background: #0d6efd;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 80px;
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
    }

    #sendBtn:hover:not(:disabled) {
        background: #0b5ed7;
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(13, 110, 253, 0.3);
    }

    #sendBtn:active:not(:disabled) {
        transform: translateY(0);
    }

    #sendBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* BOT√ìN MICR√ìFONO */
    #micBtn {
        padding: 12px 16px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 100px;
        gap: 6px;
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
    }

    #micBtn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
    }

    #micBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* BOT√ìN DETENER */
    #stopBtn {
        background: #dc3545;
        color: white;
        padding: 12px 16px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        height: 44px;
        display: none;
        align-items: center;
        justify-content: center;
        min-width: 100px;
        gap: 6px;
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
    }

    #stopBtn:hover:not(:disabled) {
        background: #c82333;
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(220, 53, 69, 0.3);
    }

    /* Loader */
    #loader {
        display: none;
        text-align: center;
        padding: 10px;
        color: #02375d;
        font-style: italic;
        background: rgba(255,255,255,0.3);
        border-radius: 10px;
        margin: 10px 0;
    }

    /* Notificaci√≥n de permiso */
    #permissionNotification {
        display: none;
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        z-index: 1000;
        text-align: center;
        max-width: 400px;
        width: 90%;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from { transform: translate(-50%, -20px); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }

    /* Scrollbar personalizada */
    #chat::-webkit-scrollbar {
        width: 6px;
    }

    #chat::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.05);
        border-radius: 10px;
    }

    #chat::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
    }

    #chat::-webkit-scrollbar-thumb:hover {
        background: rgba(0,0,0,0.3);
    }
</style>
</head>

<body>

<div id="permissionNotification">
    <div style="font-size: 18px; margin-bottom: 5px;">üé§ Permiso de micr√≥fono</div>
    <div>Por favor, haz clic en <strong>"Permitir"</strong> cuando tu navegador lo solicite</div>
    <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">(Es necesario para que pueda escucharte)</div>
</div>

<div class="app-container">
    <!-- CABECERA SEPARADA DEL CHAT -->
    <div class="header-section">
        <!-- ESTADO DE CONEXI√ìN - AHORA SEPARADO -->
        <div id="connectionStatus" class="online">
            <span class="status-icon">‚óè</span>
            <span class="status-text">Conectado</span>
        </div>
        
        <!-- BOTONES DE LA CABECERA -->
        <div class="header-buttons">
            <button class="header-btn" id="refreshChat" title="Reiniciar chat">
                üîÑ Reiniciar
            </button>
        </div>
    </div>

    <!-- CONTENEDOR DEL CHAT (SIN ESTADO DENTRO) -->
    <div id="chatContainer">
        <!-- √ÅREA DEL CHAT -->
        <div id="chat"></div>

        <!-- LOADER -->
        <div id="loader">Procesando tu mensaje...</div>

        <!-- √ÅREA DE INPUT -->
        <div id="inputBox">
            <input id="messageInput" type="text" placeholder="Escribe tu mensaje aqu√≠..." />
            <button id="sendBtn" title="Enviar mensaje">Enviar</button>
            <button id="micBtn" title="Hablar con micr√≥fono">
                <span class="mic-icon">üé§</span>
                <span class="mic-text">Hablar</span>
            </button>
            <button id="stopBtn" title="Detener grabaci√≥n">
                <span class="stop-icon">‚èπÔ∏è</span>
                <span class="stop-text">Detener</span>
            </button>
        </div>
    </div>
</div>

<script>
/* ---------------------------------------------------
    VARIABLES GLOBALES
-----------------------------------------------------*/
const N8N_WEBHOOK_URL = "https://n8n.srv1161635.hstgr.cloud/webhook/6b4f38ff-0de0-49f0-843f-a277a55bdfd5";

let sessionId = localStorage.getItem("sessionId") || crypto.randomUUID();
localStorage.setItem("sessionId", sessionId);

let reconocimiento = null;
let escuchando = false;
let botHablando = false;
let mensajeEnProceso = false;

// Elementos del DOM
const chatElement = document.getElementById("chat");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const micBtn = document.getElementById("micBtn");
const stopBtn = document.getElementById("stopBtn");
const loader = document.getElementById("loader");
const connectionStatus = document.getElementById("connectionStatus");
const permissionNotification = document.getElementById("permissionNotification");

/* ---------------------------------------------------
    INICIALIZACI√ìN
-----------------------------------------------------*/
document.addEventListener('DOMContentLoaded', () => {
    // Mensaje inicial
    setTimeout(() => {
        agregarMensajeBot(`
            <div style="text-align: left;">
                <div style="font-size: 16px; margin-bottom: 8px;"><b>¬°Hola! üëã Soy tu Asistente Virtual</b></div>
                <div style="font-size: 13px; color: #555; margin-bottom: 5px;">
                    <b>Para escribir:</b> Escribe abajo y haz clic en <b>Enviar</b>
                </div>
                <div style="font-size: 13px; color: #555;">
                    <b>Para hablar:</b> Haz clic en <b>üé§ Hablar</b> (permite el micr√≥fono)
                </div>
            </div>
        `);
    }, 300);
    
    // Verificar conexi√≥n
    actualizarEstadoConexion();
    
    // Enfocar input
    setTimeout(() => messageInput.focus(), 500);
});

/* ---------------------------------------------------
    SISTEMA DE VOZ ‚Äì TEXTO A VOZ
-----------------------------------------------------*/
function hablarGratis(texto) {
    if (!texto || botHablando) return;
    
    botHablando = true;
    bloquearEntradaUsuario(true);
    
    // Agregar ondas de audio
    agregarOndasAudio();
    
    // Detener cualquier voz anterior
    speechSynthesis.cancel();
    
    // Dividir texto en partes manejables
    const partes = dividirTextoEnPartes(texto, 200);
    let parteIndex = 0;
    
    function hablarParte() {
        if (parteIndex >= partes.length) {
            botHablando = false;
            bloquearEntradaUsuario(false);
            removerOndasAudio();
            return;
        }
        
        const parte = partes[parteIndex];
        const voz = new SpeechSynthesisUtterance(parte);
        voz.lang = "es-ES";
        voz.rate = 1.0;
        voz.pitch = 1.0;
        voz.volume = 1.0;
        
        // Configurar voces disponibles
        const voces = speechSynthesis.getVoices();
        const vozEspa√±ol = voces.find(v => v.lang.includes("es"));
        if (vozEspa√±ol) voz.voice = vozEspa√±ol;
        
        voz.onend = () => {
            parteIndex++;
            setTimeout(hablarParte, 50);
        };
        
        voz.onerror = () => {
            parteIndex++;
            setTimeout(hablarParte, 50);
        };
        
        speechSynthesis.speak(voz);
    }
    
    hablarParte();
}

function dividirTextoEnPartes(texto, maxCaracteres) {
    const partes = [];
    const oraciones = texto.match(/[^.!?]+[.!?]+/g) || [texto];
    
    let parteActual = '';
    for (let oracion of oraciones) {
        if ((parteActual + oracion).length <= maxCaracteres) {
            parteActual += oracion;
        } else {
            if (parteActual) partes.push(parteActual);
            parteActual = oracion;
        }
    }
    if (parteActual) partes.push(parteActual);
    
    return partes;
}

/* ---------------------------------------------------
    RECONOCIMIENTO DE VOZ
-----------------------------------------------------*/
function solicitarPermisoMicrofono() {
    permissionNotification.style.display = 'block';
    
    return navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            permissionNotification.style.display = 'none';
            stream.getTracks().forEach(track => track.stop());
            return true;
        })
        .catch(error => {
            permissionNotification.style.display = 'none';
            agregarMensajeBot("‚ùå Permiso de micr√≥fono denegado. Usa el teclado para escribir.");
            return false;
        });
}

function iniciarReconocimientoVoz() {
    if (escuchando) {
        detenerReconocimientoVoz();
        return;
    }
    
    if (botHablando || mensajeEnProceso) {
        agregarMensajeBot("‚åõ Espera a que termine...");
        return;
    }
    
    solicitarPermisoMicrofono().then(permisoConcedido => {
        if (!permisoConcedido) return;
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            agregarMensajeBot("‚ö†Ô∏è Usa Chrome o Edge para hablar.");
            return;
        }
        
        reconocimiento = new SpeechRecognition();
        reconocimiento.lang = "es-ES";
        reconocimiento.continuous = false;
        reconocimiento.interimResults = false;
        reconocimiento.maxAlternatives = 1;
        
        reconocimiento.onstart = () => {
            escuchando = true;
            micBtn.classList.add("recording");
            micBtn.style.display = "none";
            stopBtn.style.display = "flex";
            
            agregarMensajeBot("üé§ <b>Escuchando...</b> Di algo ahora.");
        };
        
        reconocimiento.onresult = (evento) => {
            if (evento.results.length > 0) {
                const texto = evento.results[0][0].transcript;
                if (texto.trim().length > 0) {
                    messageInput.value = texto;
                    setTimeout(() => sendMessage(), 100);
                } else {
                    agregarMensajeBot("No escuch√© nada claro. Intenta de nuevo.");
                }
            }
        };
        
        reconocimiento.onend = () => {
            escuchando = false;
            micBtn.classList.remove("recording");
            micBtn.style.display = "flex";
            stopBtn.style.display = "none";
        };
        
        reconocimiento.onerror = (evento) => {
            escuchando = false;
            micBtn.classList.remove("recording");
            micBtn.style.display = "flex";
            stopBtn.style.display = "none";
            
            if (evento.error === "not-allowed") {
                agregarMensajeBot("‚ùå Permiso de micr√≥fono denegado.");
            } else if (evento.error === "no-speech") {
                agregarMensajeBot("üé§ No detect√© voz. Intenta de nuevo.");
            }
        };
        
        try {
            reconocimiento.start();
        } catch (error) {
            console.error("Error al iniciar reconocimiento:", error);
            agregarMensajeBot("Error al iniciar el micr√≥fono.");
        }
    });
}

function detenerReconocimientoVoz() {
    if (reconocimiento && escuchando) {
        reconocimiento.stop();
    }
    escuchando = false;
    micBtn.classList.remove("recording");
    micBtn.style.display = "flex";
    stopBtn.style.display = "none";
}

/* ---------------------------------------------------
    MANEJO DE ENTRADA DEL USUARIO
-----------------------------------------------------*/
function bloquearEntradaUsuario(bloquear) {
    messageInput.disabled = bloquear;
    sendBtn.disabled = bloquear;
    micBtn.disabled = bloquear;
    stopBtn.disabled = bloquear;
    
    if (bloquear) {
        messageInput.placeholder = "Bot respondiendo...";
    } else {
        messageInput.placeholder = "Escribe tu mensaje aqu√≠...";
        messageInput.focus();
    }
}

/* ---------------------------------------------------
    ONDAS DE AUDIO
-----------------------------------------------------*/
function agregarOndasAudio() {
    const mensajesBot = document.querySelectorAll('.msg.bot');
    if (mensajesBot.length === 0) return;
    
    const ultimoMensaje = mensajesBot[mensajesBot.length - 1];
    
    const ondasAnteriores = ultimoMensaje.querySelector('.audio-waves');
    if (ondasAnteriores) ondasAnteriores.remove();
    
    const ondas = document.createElement('div');
    ondas.className = 'audio-waves';
    ondas.id = 'audioWaves';
    
    for (let i = 0; i < 7; i++) {
        const barra = document.createElement('div');
        barra.className = 'wave-bar';
        ondas.appendChild(barra);
    }
    
    ultimoMensaje.appendChild(ondas);
    chatElement.scrollTop = chatElement.scrollHeight;
}

function removerOndasAudio() {
    const ondas = document.getElementById('audioWaves');
    if (ondas) {
        ondas.remove();
    }
}

/* ---------------------------------------------------
    EVENTOS PRINCIPALES
-----------------------------------------------------*/
// Eventos de teclado
messageInput.addEventListener("keypress", e => {
    if (e.key === "Enter" && !mensajeEnProceso && !botHablando) {
        sendMessage();
    }
});

sendBtn.addEventListener("click", sendMessage);
micBtn.addEventListener("click", iniciarReconocimientoVoz);
stopBtn.addEventListener("click", detenerReconocimientoVoz);

// Eventos de conexi√≥n
window.addEventListener('online', actualizarEstadoConexion);
window.addEventListener('offline', actualizarEstadoConexion);

// Evento refresh
document.getElementById("refreshChat").addEventListener("click", () => {
    if (chatElement.children.length === 0 || 
        confirm("¬øReiniciar la conversaci√≥n?")) {
        
        if (botHablando) speechSynthesis.cancel();
        detenerReconocimientoVoz();
        
        chatElement.innerHTML = "";
        sessionId = crypto.randomUUID();
        localStorage.setItem("sessionId", sessionId);
        
        botHablando = false;
        mensajeEnProceso = false;
        bloquearEntradaUsuario(false);
        
        setTimeout(() => {
            agregarMensajeBot(`
                <div style="text-align: left;">
                    <div style="font-size: 16px; margin-bottom: 5px;"><b>¬°Conversaci√≥n reiniciada! üîÑ</b></div>
                    <div style="font-size: 13px; color: #555;">¬øEn qu√© puedo ayudarte ahora?</div>
                </div>
            `);
        }, 300);
    }
});

// Pausar voz al hacer clic
document.addEventListener('click', (e) => {
    if (botHablando && e.target.id !== 'sendBtn' && e.target.id !== 'micBtn' && e.target.id !== 'stopBtn') {
        speechSynthesis.cancel();
        botHablando = false;
        bloquearEntradaUsuario(false);
        removerOndasAudio();
    }
});

/* ---------------------------------------------------
    ENVIAR MENSAJE AL SERVIDOR
-----------------------------------------------------*/
async function sendMessage() {
    const message = messageInput.value.trim();
    
    if (!message) {
        if (!escuchando) {
            agregarMensajeBot("Escribe algo o haz clic en üé§ Hablar.");
        }
        return;
    }
    
    if (mensajeEnProceso || botHablando) {
        agregarMensajeBot("‚åõ Por favor espera...");
        return;
    }
    
    agregarMensajeUsuario(message);
    messageInput.value = "";
    mensajeEnProceso = true;
    bloquearEntradaUsuario(true);
    mostrarProcesando(true);
    
    try {
        const response = await fetch(N8N_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                message, 
                sessionId,
                timestamp: new Date().toISOString()
            })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        const respuesta = data.output || data.message || data.reply || "No entend√≠. ¬øPuedes reformular?";
        
        agregarMensajeBot(respuesta);
        hablarGratis(respuesta);

    } catch (error) {
        console.error("Error:", error);
        
        let mensajeError = "‚ö†Ô∏è Error de conexi√≥n.";
        
        if (!navigator.onLine) {
            mensajeError = "üåê Sin conexi√≥n a internet.";
        } else if (error.message.includes("Failed to fetch")) {
            mensajeError = "üîå No puedo contactar al servidor.";
        }
        
        agregarMensajeBot(mensajeError);
        
        setTimeout(() => {
            if (!botHablando) bloquearEntradaUsuario(false);
        }, 2000);
        
    } finally {
        mensajeEnProceso = false;
        mostrarProcesando(false);
    }
}

/* ---------------------------------------------------
    MANEJO DE MENSAJES EN EL CHAT
-----------------------------------------------------*/
function agregarMensajeUsuario(msg) {
    const burbuja = document.createElement("div");
    burbuja.className = "msg user";
    burbuja.textContent = msg;
    chatElement.appendChild(burbuja);
    chatElement.scrollTop = chatElement.scrollHeight;
}

function agregarMensajeBot(msgHTML) {
    const burbuja = document.createElement("div");
    burbuja.className = "msg bot";
    burbuja.innerHTML = msgHTML;
    chatElement.appendChild(burbuja);
    chatElement.scrollTop = chatElement.scrollHeight;
}

/* ---------------------------------------------------
    FUNCIONES AUXILIARES
-----------------------------------------------------*/
function mostrarProcesando(show) {
    loader.style.display = show ? "block" : "none";
}

function actualizarEstadoConexion() {
    if (navigator.onLine) {
        connectionStatus.className = "online";
        connectionStatus.innerHTML = '<span class="status-icon">‚óè</span><span class="status-text">Conectado</span>';
    } else {
        connectionStatus.className = "offline";
        connectionStatus.innerHTML = '<span class="status-icon">‚óè</span><span class="status-text">Sin conexi√≥n</span>';
        
        if (mensajeEnProceso) {
            agregarMensajeBot("‚ö†Ô∏è Se perdi√≥ la conexi√≥n.");
        }
    }
}

/* ---------------------------------------------------
    MANEJO DE CIERRE
-----------------------------------------------------*/
window.addEventListener('beforeunload', () => {
    if (botHablando) speechSynthesis.cancel();
    detenerReconocimientoVoz();
});
</script>

</body>
</html>
