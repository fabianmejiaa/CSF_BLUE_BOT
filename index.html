<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistente Virtual</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #0d0d0f;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    #chatContainer {
        width: 420px;
        height: 85vh;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(14px);
        position: relative;
    }

    #refreshChat {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255,255,255,0.15);
        border: none;
        color: white;
        padding: 6px 10px;
        cursor: pointer;
        border-radius: 10px;
        backdrop-filter: blur(8px);
        transition: 0.2s;
        font-size: 18px;
    }

    #refreshChat:hover {
        background: rgba(255,255,255,0.25);
    }

    #chat {
        flex: 1;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 10px;
    }

    .msg {
        margin-bottom: 12px;
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 80%;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .user {
        background: rgba(0, 140, 255, 0.3);
        margin-left: auto;
        text-align: right;
    }

    .bot {
        background: rgba(255, 255, 255, 0.15);
    }

    #inputBox {
        display: flex;
        margin-top: auto;
    }

    #messageInput {
        flex: 1;
        padding: 10px;
        border-radius: 12px;
        border: none;
        outline: none;
        background: rgba(255,255,255,0.1);
        color: white;
        font-size: 14px;
    }

    #sendBtn {
        margin-left: 8px;
        padding: 10px 14px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.2s;
        font-size: 14px;
    }

    #sendBtn:hover {
        background: #0a8bff;
    }

    #loader {
        display: none;
        text-align: center;
        padding: 10px;
        color: #aaa;
        font-style: italic;
    }

    .loading-dots {
        display: inline-block;
    }
    .loading-dots span {
        animation: blink 1.4s infinite both;
        animation-delay: 0.2s;
    }
    .loading-dots span:nth-child(2) {
        animation-delay: 0.4s;
    }
    .loading-dots span:nth-child(3) {
        animation-delay: 0.6s;
    }
    @keyframes blink {
        0%, 80%, 100% { opacity: 0; }
        40% { opacity: 1; }
    }
</style>
</head>
<body>

<div id="chatContainer">
    <button id="refreshChat">â†»</button>
    <div id="chat"></div>
    
    <!-- Elemento loader que estaba faltando -->
    <div id="loader">
        <span class="loading-dots">
            <span>.</span><span>.</span><span>.</span>
        </span>
    </div>
    
    <div id="inputBox">
        <input id="messageInput" type="text" placeholder="Escribe tu mensaje..." />
        <button id="sendBtn">Enviar</button>
    </div>
</div>

<script>
const N8N_WEBHOOK_URL = "https://n8n.srv1161635.hstgr.cloud/webhook/6b4f38ff-0de0-49f0-843f-a277a55bdfd5";
let sessionId = localStorage.getItem("sessionId") || crypto.randomUUID();
localStorage.setItem("sessionId", sessionId);

// Mensaje inicial automÃ¡tico
window.onload = () => {
    agregarMensajeBot(`
        <b>Â¡Hola! ðŸ‘‹ Soy tu Asistente Virtual TEC.</b><br>
        Estoy aquÃ­ para ayudarte a resolver cualquier problema tÃ©cnico o acadÃ©mico.<br><br>
        CuÃ©ntame, Â¿en quÃ© puedo ayudarte hoy?
    `);
};

// CORRECCIÃ“N 1: Event listeners corregidos
document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("messageInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        sendMessage();
    }
});

// ---------------------------------------------------------
// ENVIO DEL MENSAJE
// ---------------------------------------------------------
async function sendMessage() {
    const input = document.getElementById("messageInput");
    const message = input.value.trim();
    if (!message) return;

    agregarMensajeUsuario(message);
    input.value = "";

    mostrarProcesando(true);

    try {
        const response = await fetch(N8N_WEBHOOK_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify({
                message: message,
                sessionId: sessionId
            })
        });

        console.log("Respuesta status:", response.status);

        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }

        const data = await response.json();
        console.log("Respuesta JSON:", data);

        // Manejar diferentes estructuras de respuesta
        let respuesta = "";
        if (data && data.output) {
            respuesta = data.output;
        } else if (data && data.message) {
            respuesta = data.message;
        } else if (data && typeof data === 'string') {
            respuesta = data;
        } else {
            respuesta = "RecibÃ­ una respuesta sin formato reconocido";
        }

        agregarMensajeBot(formatearHTMLSeguro(respuesta));

    } catch (error) {
        console.error("Error completo:", error);
        agregarMensajeBot(`
            Error al conectar con el servidor ðŸ˜•<br>
            <small>Detalles: ${error.message}</small>
        `);
    }

    mostrarProcesando(false);
}

// ---------------------------------------------------------
// MUESTRA EL MENSAJE DEL USUARIO
// ---------------------------------------------------------
function agregarMensajeUsuario(msg) {
    const chat = document.getElementById("chat");
    const burbuja = document.createElement("div");
    burbuja.className = "msg user";
    burbuja.textContent = msg;
    chat.appendChild(burbuja);
    chat.scrollTop = chat.scrollHeight;
}

// ---------------------------------------------------------
// MUESTRA EL MENSAJE DEL BOT (HTML PERMITIDO)
// ---------------------------------------------------------
function agregarMensajeBot(msgHTML) {
    const chat = document.getElementById("chat");
    const burbuja = document.createElement("div");
    burbuja.className = "msg bot";
    burbuja.innerHTML = msgHTML;
    chat.appendChild(burbuja);
    chat.scrollTop = chat.scrollHeight;
}

// ---------------------------------------------------------
// ANIMACIÃ“N "Procesando..."
// ---------------------------------------------------------
function mostrarProcesando(show) {
    const loader = document.getElementById("loader");
    if (loader) {
        loader.style.display = show ? "block" : "none";
    }
}

// ---------------------------------------------------------
// FORMATEO SEGURO
// ---------------------------------------------------------
function formatearHTMLSeguro(texto) {
    if (!texto) return "";
    texto = texto.replace(
        /\[([^\]]+)\]\((https?:\/\/[^\s()<>]+)\)/g,
        (m, label, url) => `<a href="${url}" target="_blank" style="color:red;">${label}</a>`
    );
    texto = texto.replace(
        /(?<!href=")(?<!href=')(https?:\/\/[^\s"'<>]+)/g,
        (m, url) => `<a href="${url}" target="_blank" style="color:red;">${url}</a>`
    );
    return texto;
}
// ---------------------------------------------------------
// REFRESCAR CHAT
// ---------------------------------------------------------
function refrescarChat() {
    const chat = document.getElementById("chat");
    chat.innerHTML = "";
    sessionId = crypto.randomUUID();
    localStorage.setItem("sessionId", sessionId);
    agregarMensajeBot("<b>Â¡Chat reiniciado!</b> ðŸ”„<br>Â¿En quÃ© puedo ayudarte ahora?");
}

document.getElementById("refreshChat").addEventListener("click", refrescarChat);
</script>
</body>
</html>
